# Тур по структуре кода
В некоторых директориях имеется `README.md`,
описывающий предназначение вложенных
файлов и папок.


## Цикл обновлений
Цикл скачивания расписаний находится
в [`crate::data::schedule::raw::Index::update_forever`](/src/data/schedule/raw/index.rs?blame=1#L281).

Оттуда посылается сигнал об окончании
скачивания, который затем принимается
[`crate::data::container::schedule::Schedule::await_updates`](/src/data/container/schedule.rs?blame=1#L77).

Там расписания парсятся, объединяются и сравниваются.


## Парсинг
Происходит в 2 этапа:
- HTML → таблица ([`crate::parse::sheet::html`](/src/parse/sheet/html.rs))
- Таблица → объекты ([`crate::parse::sheet::table`](/src/parse/sheet/table.rs))


### Первый этап
Превращает HTML в 2D массив.
- Фильтруются пустые строки
- Парсится CSS для получения цвета ячейки
- Считаются X и Y координаты для определения
объединённых ячеек

В этой таблице сохраняются данные о ячейках:
- Текст
- Ширина и высота
- Цвет (для опознавания формата предмета)


### Второй этап
Превращает таблицу в конечные объекты.
- Проверяются ячейки с датами
- Распознаются объединённые ячейки
- Парсится содержимое ячеек
- Ячейки ассоциируются с датами и формированиями
с помощью координат


## Объединение
- Одинаковые типы расписаний объединяются здесь:
[`crate::merge::combine`](/src/merge/mod.rs?blame=1#L370).

- Дополнение происходит здесь:
[`crate::merge::complement`](/src/merge/mod.rs?blame=1#L29).

  - Проходит в две итерации, сначала дополняются
    преподы от групп,
    а потом группы от преподов.

    Преподы ищутся по расстоянию Дамерау-Левенштейна.


## Сравнение
Используется несколько моделей сравнения:
- Примитивное ([`crate::compare::Primitive`](/src/compare/mod.rs?blame=1#L227)), где значение единичное (номер предмета, кабинет). Хранит старое и новое значение.
- Детальное ([`crate::compare::DetailedChanges`](/src/compare/mod.rs?blame=1#L88)),
где используются списки (список формирований,
список посетителей предмета).
Хранит появившиеся, исчезнувшие и изменившиеся типы.

У объектов расписания имплементирован трейт,
по которому они могут сравниваться друг с другом:
[`crate::compare::FindingCmp`](/src/compare/mod.rs?blame=1#L19).

"Сравнительные" версии обычных объектов расписания
находятся в [`crate::compare::schedule`](/src/compare/schedule.rs).


## Объекты расписания
Объекты расписания описаны в
[`crate::data::schedule`](/src/data/schedule/mod.rs).

- `Page`: страница, содержит формирования
(либо группы, либо преподов)
- `Formation`: формирование (либо группа, либо препод),
содержит дни
- `Day`: день, содержит предметы
- `Subject`: предмет, содержит посетителей (либо преподов, либо группы)
- `Attender`: посетитель (либо препод, либо группа),
содержит кабинет
- `Cabinet`: кабинет, хранит основной вариант
и вариант найденный в противоположном расписании


## API
Объекты ответов находятся в [`crate::api`](/src/api/mod.rs).

Эндпоинты расписаний находятся в
[`crate::api::schedule::groups`](/src/api/schedule/groups.rs) и
[`crate::api::schedule::teachers`](/src/api/schedule/teachers.rs).

Код для WebSocket канала в
[`crate::api::schedule`](/src/api/schedule/mod.rs).